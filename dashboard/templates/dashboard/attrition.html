{% extends "base.html" %}
{% load dashboard_filters %}

{% block title %}Attrition Risk Analysis - HR Analytics{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

    <!-- HEADER -->
    <h1 class="mb-1">Attrition Risk Analysis</h1>
    <p class="text-muted mb-4">Identify employees at risk of leaving</p>

    <!-- FILTER -->
    <form method="get" class="form-inline mb-4">
        <select name="department" class="form-control">
            <option value="">All Departments</option>
            {% for dept in departments_list %}
            <option value="{{ dept }}" {% if selected_department == dept %}selected{% endif %}>
                {{ dept }}
            </option>
            {% endfor %}
        </select>

        <button class="btn btn-primary ml-2" type="submit">Filter</button>
    </form>

    {% if model_error %}
        <div class="alert alert-warning">Attrition model not available.</div>
    {% else %}

    <!-- KPI + Distribution -->
    <div class="row mb-4">

        <!-- KPI CARD -->
        <div class="col-md-6 mb-4">
            <div class="kpi-card red">
                <h5>High Risk Employees</h5>
                <h2 class="display-4">{{ high_risk_count }}</h2>
                <p>{{ high_risk_pct }}% of workforce</p>
            </div>
        </div>

        <!-- RISK DISTRIBUTION CHART -->
        <div class="col-md-6 mb-4">
            <div class="chart-container">
                <h5>Risk Distribution</h5>
                <div class="chart-box">
                    {{ risk_plot|safe }}
                </div>
            </div>
        </div>
    </div>

    <!-- DEPARTMENT RISK -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="chart-container">
                <h5>Attrition Risk by Department</h5>
                <div class="chart-box">
                    {% if dept_risk_plot %}
                        {{ dept_risk_plot|safe }}
                    {% else %}
                        <img src="{{ charts.high_risk_by_level }}" class="img-fluid" style="max-height: 100%; object-fit: contain;">
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- HIGH RISK TABLE -->
    {% if high_risk_employees %}
    <div class="row">
        <div class="col-md-12 mb-4">
            <div class="chart-container">
                <h5>High Risk Employees</h5>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Employee ID</th>
                                <th>Department</th>
                                <th>Job Level</th>
                                <th>Tenure (years)</th>
                                <th>Risk Score</th>
                                <th>Action</th>
                            </tr>
                        </thead>

                        <tbody>
                            {% for employee in high_risk_employees %}
                            <tr>
                                <td>{{ employee.employee_id }}</td>
                                <td>{{ employee.department }}</td>
                                <td>{{ employee.job_level }}</td>
                                <td>{{ employee.tenure|floatformat:1 }}</td>
                                <td style="width:220px;">
                                    <div class="progress">
                                        <div class="progress-bar bg-danger"
                                             style="width: {{ employee.attrition_probability|floatformat:2|mul:100 }}%;">
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <a href="{% url 'employee_detail' employee.employee_id %}"
                                       class="btn btn-sm btn-outline-primary">
                                        Details
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>

                    </table>
                </div>

            </div>
        </div>
    </div>
    {% endif %}

    {% endif %}

</div>
{% endblock %}
